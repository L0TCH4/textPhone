<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Text Phone</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
:root {
  --bg: #0e0e11;
  --panel: #17171c;
  --text: #ffffff;
  --sub: #9a9aa3;
  --accent: #4f7cff;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== Header (Call Bar) ===== */
header {
  height: 48px;
  background: var(--panel);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  font-size: 13px;
}

#callStatus {
  text-align: center;
  flex: 1;
  font-weight: 600;
}

#callStatus span {
  color: var(--sub);
  font-weight: 400;
  font-size: 12px;
}

#togglePanel {
  background: none;
  border: none;
  color: var(--sub);
  font-size: 18px;
}

/* ===== Panel ===== */
#panel {
  display: none;
  background: var(--panel);
  padding: 10px;
  font-size: 12px;
}

#panel input, #panel button {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px;
  font-size: 12px;
  border-radius: 6px;
  border: none;
}

#panel input {
  background: #22222a;
  color: var(--text);
}

#panel button {
  background: var(--accent);
  color: white;
}

#shareUrl {
  word-break: break-all;
  color: var(--sub);
  font-size: 11px;
}

/* ===== Text Areas ===== */
#remote, #localView {
  flex: 1;
  padding: 18px;
  font-size: 20px;
  line-height: 1.5;
  word-break: break-all;
}

#remote {
  border-bottom: 1px solid #222;
}

.char {
  transition: opacity 0.4s;
}

.char.dead {
  opacity: 0;
}

#composing {
  opacity: 0.5;
}

/* ===== Input ===== */
footer {
  padding: 10px;
  background: var(--panel);
}

#textInput {
  width: 100%;
  font-size: 20px;
  padding: 10px;
  border-radius: 10px;
  border: none;
  background: #22222a;
  color: var(--text);
}
</style>
</head>
<body>

<header>
  <div style="width:24px"></div>
  <div id="callStatus">
    Waiting…<br><span>not connected</span>
  </div>
  <button id="togglePanel" onclick="togglePanel()">⚙</button>
</header>

<div id="panel">
  <input id="nameInput" placeholder="あなたの名前">
  <button onclick="copyShareUrl()">共有URLをコピー</button>
  <div id="shareUrl"></div>
</div>

<div id="remote"></div>
<div id="localView"></div>

<footer>
  <input id="textInput" placeholder="話すように入力…" autocomplete="off">
</footer>

<script>
const peer = new Peer();
let conn = null;
const TTL = 3000;

const remote = document.getElementById("remote");
const localView = document.getElementById("localView");
const textInput = document.getElementById("textInput");
const shareUrlDiv = document.getElementById("shareUrl");
const callStatus = document.getElementById("callStatus");
const panel = document.getElementById("panel");

let isComposing = false;
let composingSpan = null;
let shareUrl = "";
let remoteName = "Unknown";

function togglePanel() {
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

peer.on("open", id => {
  shareUrl = `${location.origin}${location.pathname}?connect=${id}`;
  shareUrlDiv.textContent = shareUrl;

  const p = new URLSearchParams(location.search);
  const target = p.get("connect");
  if (target && target !== id) {
    conn = peer.connect(target);
    setupConn();
  }
});

peer.on("connection", c => {
  conn = c;
  setupConn();
});

function setupConn() {
  conn.on("open", () => {
    const myName = document.getElementById("nameInput").value || "匿名";
    conn.send({ type: "hello", name: myName });
  });

  conn.on("data", data => {
    if (data.type === "hello") {
      remoteName = data.name;
      callStatus.innerHTML = `${remoteName}<br><span>connected</span>`;
      return;
    }
    spawnChar(remote, data.char);
  });
}

function spawnChar(target, char) {
  const span = document.createElement("span");
  span.className = "char";
  span.textContent = char;
  target.appendChild(span);

  setTimeout(() => span.classList.add("dead"), TTL);
  setTimeout(() => span.remove(), TTL + 500);
}

function copyShareUrl() {
  navigator.clipboard.writeText(shareUrl).then(() => {
    alert("共有URLをコピーしました");
  });
}

/* ===== IME対応 ===== */

textInput.addEventListener("compositionstart", () => {
  isComposing = true;
  composingSpan = document.createElement("span");
  composingSpan.id = "composing";
  localView.appendChild(composingSpan);
});

textInput.addEventListener("compositionupdate", e => {
  if (composingSpan) composingSpan.textContent = e.data;
});

textInput.addEventListener("compositionend", e => {
  isComposing = false;
  if (composingSpan) composingSpan.remove();
  composingSpan = null;

  sendText(e.data);
});

textInput.addEventListener("input", e => {
  if (isComposing) return;
  if (e.target.value) sendText(e.target.value);
});

function sendText(text) {
  for (const char of text) {
    spawnChar(localView, char);
    if (conn && conn.open) conn.send({ char });
  }
  textInput.value = "";
}
</script>

</body>
</html>
