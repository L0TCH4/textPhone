<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Text Phone</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

<style>
:root {
  --bg1: #0f2027;
  --bg2: #203a43;
  --bg3: #2c5364;
  --glass: rgba(255,255,255,0.08);
  --border: rgba(255,255,255,0.15);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, var(--bg1), var(--bg3));
  color: #fff;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header {
  padding: 10px 14px;
  font-size: 12px;
  opacity: 0.8;
}

#stage {
  flex: 1;
  position: relative;
  padding: 20px;
}

.layer {
  position: absolute;
  inset: 0;
  padding: 20px;
  pointer-events: none;
}

#remote {
  text-align: left;
}

#localView {
  text-align: right;
}

.char {
  display: inline-block;
  margin: 2px;
  padding: 6px 10px;
  border-radius: 14px;
  background: var(--glass);
  backdrop-filter: blur(8px);
  animation: floatUp 3s linear forwards;
}

@keyframes floatUp {
  0%   { opacity: 1; transform: translateY(0); }
  70%  { opacity: 1; }
  100% { opacity: 0; transform: translateY(-30px); }
}

#composing {
  opacity: 0.6;
}

footer {
  background: linear-gradient(
    to top,
    rgba(0,0,0,0.6),
    rgba(0,0,0,0)
  );
  padding: 12px;
}

.card {
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 10px;
  margin-bottom: 8px;
}

input, button {
  width: 100%;
  font-size: 16px;
  border-radius: 14px;
  border: none;
  padding: 10px;
}

input {
  background: rgba(0,0,0,0.4);
  color: #fff;
}

button {
  background: linear-gradient(135deg, #4facfe, #00f2fe);
  color: #000;
  font-weight: 600;
}

#textInput {
  font-size: 18px;
}

#shareUrl {
  font-size: 11px;
  opacity: 0.7;
  word-break: break-all;
}

#toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.3s;
}
#toast.show { opacity: 1; }
</style>
</head>

<body>

<header>
  Your ID: <span id="myId">...</span>
</header>

<div id="stage">
  <div id="remote" class="layer"></div>
  <div id="localView" class="layer"></div>
</div>

<footer>
  <div class="card">
    <input id="nameInput" placeholder="あなたの名前">
    <input id="peerInput" placeholder="相手のPeer ID">
    <button onclick="connect()">接続</button>
  </div>

  <div class="card">
    <button onclick="copyShareUrl()">共有URLをコピー</button>
    <div id="shareUrl"></div>
  </div>

  <input id="textInput" placeholder="話すように入力…" autocomplete="off">
</footer>

<div id="toast">コピーしました</div>

<script>
const peer = new Peer();
let conn = null;
const TTL = 3000;

const remote = document.getElementById("remote");
const localView = document.getElementById("localView");
const textInput = document.getElementById("textInput");
const shareUrlDiv = document.getElementById("shareUrl");
const toast = document.getElementById("toast");

let isComposing = false;
let composingSpan = null;
let shareUrl = "";

peer.on("open", id => {
  document.getElementById("myId").textContent = id;
  shareUrl = `${location.origin}${location.pathname}?connect=${id}`;
  shareUrlDiv.textContent = shareUrl;

  const p = new URLSearchParams(location.search);
  if (p.get("connect")) {
    document.getElementById("peerInput").value = p.get("connect");
    connect();
  }
});

peer.on("connection", c => {
  conn = c;
  setupConn();
});

function connect() {
  const id = document.getElementById("peerInput").value;
  if (!id) return;
  conn = peer.connect(id);
  setupConn();
}

function setupConn() {
  conn.on("data", d => spawnChar(remote, d.char));
}

function spawnChar(target, char) {
  const span = document.createElement("span");
  span.className = "char";
  span.textContent = char;
  target.appendChild(span);
  setTimeout(() => span.remove(), TTL);
}

function copyShareUrl() {
  navigator.clipboard.writeText(shareUrl);
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 1200);
}

/* IME */
textInput.addEventListener("compositionstart", () => {
  isComposing = true;
  composingSpan = document.createElement("span");
  composingSpan.id = "composing";
  localView.appendChild(composingSpan);
});
textInput.addEventListener("compositionupdate", e => {
  if (composingSpan) composingSpan.textContent = e.data;
});
textInput.addEventListener("compositionend", e => {
  isComposing = false;
  if (composingSpan) composingSpan.remove();
  for (const c of e.data) {
    spawnChar(localView, c);
    if (conn?.open) conn.send({ char: c });
  }
  textInput.value = "";
});
textInput.addEventListener("input", e => {
  if (isComposing) return;
  for (const c of e.target.value) {
    spawnChar(localView, c);
    if (conn?.open) conn.send({ char: c });
  }
  e.target.value = "";
});
</script>

</body>
</html>
