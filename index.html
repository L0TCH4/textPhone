<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Text Phone</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0f0f0f;
  color: #fff;
  height: 100vh;
  display: flex;
  flex-direction: column;
}
header {
  padding: 6px 10px;
  background: #181818;
  font-size: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#togglePanel {
  font-size: 12px;
  padding: 4px 8px;
}
#panel {
  background: #181818;
  padding: 8px;
  font-size: 12px;
  display: none;
}
#panel input, #panel button {
  font-size: 12px;
  padding: 4px;
  margin-bottom: 6px;
  width: 100%;
}
#shareUrl {
  word-break: break-all;
  opacity: 0.7;
}
#remote, #localView {
  flex: 1;
  padding: 14px;
  font-size: 20px;
  line-height: 1.4;
  word-break: break-all;
}
#remote {
  border-bottom: 1px solid #333;
}
.char {
  opacity: 1;
  transition: opacity 0.4s;
}
.char.dead {
  opacity: 0;
}
#composing {
  opacity: 0.6;
}
footer {
  padding: 6px;
  background: #181818;
}
#textInput {
  width: 100%;
  font-size: 20px;
  padding: 8px;
}
</style>
</head>
<body>

<header>
  <div>Your ID: <span id="myId">...</span></div>
  <button id="togglePanel" onclick="togglePanel()">⚙</button>
</header>

<div id="panel">
  <input id="nameInput" placeholder="あなたの名前">
  <button onclick="copyShareUrl()">共有URLをコピー</button>
  <div id="shareUrl"></div>
</div>

<div id="remote"></div>
<div id="localView"></div>

<footer>
  <input id="textInput" placeholder="話すように入力…" autocomplete="off">
</footer>

<script>
const peer = new Peer();
let conn = null;
const TTL = 3000;

const remote = document.getElementById("remote");
const localView = document.getElementById("localView");
const textInput = document.getElementById("textInput");
const shareUrlDiv = document.getElementById("shareUrl");
const panel = document.getElementById("panel");

let isComposing = false;
let composingSpan = null;
let shareUrl = "";

function togglePanel() {
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

peer.on("open", id => {
  document.getElementById("myId").textContent = id;

  shareUrl = `${location.origin}${location.pathname}?connect=${id}`;
  shareUrlDiv.textContent = shareUrl;

  const p = new URLSearchParams(location.search);
  const target = p.get("connect");
  if (target && target !== id) {
    conn = peer.connect(target);
    setupConn();
  }
});

peer.on("connection", c => {
  conn = c;
  setupConn();
});

function setupConn() {
  conn.on("data", data => {
    spawnChar(remote, data.char);
  });
}

function spawnChar(target, char) {
  const span = document.createElement("span");
  span.className = "char";
  span.textContent = char;
  target.appendChild(span);

  setTimeout(() => span.classList.add("dead"), TTL);
  setTimeout(() => span.remove(), TTL + 500);
}

function copyShareUrl() {
  navigator.clipboard.writeText(shareUrl).then(() => {
    alert("共有URLをコピーしました");
  });
}

/* ===== IME対応 ===== */

textInput.addEventListener("compositionstart", () => {
  isComposing = true;
  composingSpan = document.createElement("span");
  composingSpan.id = "composing";
  localView.appendChild(composingSpan);
});

textInput.addEventListener("compositionupdate", e => {
  if (composingSpan) composingSpan.textContent = e.data;
});

textInput.addEventListener("compositionend", e => {
  isComposing = false;
  if (composingSpan) composingSpan.remove();
  composingSpan = null;

  const text = e.data;
  for (const char of text) {
    spawnChar(localView, char);
    if (conn && conn.open) conn.send({ char });
  }
  textInput.value = "";
});

textInput.addEventListener("input", e => {
  if (isComposing) return;

  const text = e.target.value;
  if (!text) return;

  for (const char of text) {
    spawnChar(localView, char);
    if (conn && conn.open) conn.send({ char });
  }
  e.target.value = "";
});
</script>

</body>
</html>
